name: Deploy Arzonic to VPS

on:
  push:
    branches: [main]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: bash
        working-directory: /home/arzonic/htdocs/arzonic.com

    steps:
      - name: ðŸ”§ Git setup (HTTPS + token, no SSH)
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ ! -d .git ]; then
            git init .
            git remote add origin "https://github.com/${REPO}.git"
          fi
          # Brug GITHUB_TOKEN til at autentificere alle fetch/push (push bruger du ikke her)
          git config http."https://github.com/".extraheader "AUTHORIZATION: basic $(printf x-access-token:${TOKEN} | base64 -w0 2>/dev/null || printf x-access-token:${TOKEN} | base64)"
          git config pull.ff only

      - name: ðŸ”„ Sync til prÃ¦cis commit
        env:
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          echo "Fetching ${SHA}â€¦"
          git fetch --no-tags --depth=1 origin "${SHA}"
          git checkout --force "${SHA}"
          git rev-parse HEAD

      - name: ðŸ“¦ Install dependencies
        run: npm ci
        timeout-minutes: 10

      - name: ðŸ”§ Build Next.js project
        run: npm run build
        timeout-minutes: 20

      - name: ðŸš€ Restart PM2 process
        run: |
          set -e
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          pm2 delete arzonic-app || true
          PORT=7000 pm2 start npm --name "arzonic-app" -- start
          pm2 save
          pm2 list

      - name: âœ… Done
        run: echo "ðŸš€ Deployment successful!"
