name: Deploy Arzonic to VPS

on:
  push:
    branches: [main]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: bash
        working-directory: /home/arzonic/htdocs/arzonic.com

    steps:
      - name: ðŸ§­ Ensure repo & remote (SSH)
        env:
          REPO: ${{ github.repository }}
        run: |
          if [ ! -d .git ]; then
            git init .
            git remote add origin git@github.com:${REPO}.git
          fi
          git remote set-url origin git@github.com:${REPO}.git
          git config pull.ff only

      - name: ðŸ”„ Sync to pushed commit
        env:
          GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=accept-new"
          SHA: ${{ github.sha }}
        run: |
          git fetch --depth=1 origin ${SHA}
          git checkout --force ${SHA}

      - name: ðŸ“¦ Install dependencies
        run: npm ci
        timeout-minutes: 10

      - name: ðŸ”§ Build Next.js project
        run: npm run build
        timeout-minutes: 20

      - name: ðŸš€ Restart PM2 process
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          pm2 delete arzonic-app || true
          PORT=7000 pm2 start npm --name "arzonic-app" -- start
          pm2 save
          pm2 list

      - name: âœ… Deployment completed
        run: echo "ðŸš€ Deployment successful!"
